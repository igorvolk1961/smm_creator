{% extends "base.html" %}

{% block title %}Аналитика - SMM Assistant{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Аналитика</h1>
    </div>

    <!-- Фильтры -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateFrom" class="form-label">С</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-3">
                            <label for="dateTo" class="form-label">По</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                        <div class="col-md-2">
                            <label for="platform" class="form-label">Платформа</label>
                            <select class="form-select" id="platform">
                                <option value="vk">ВКонтакте</option>
                            </select>
                        </div>
                    <div class="col-md-2" id="vkGroupSelect" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Используется настроенное сообщество</small>
                        </div>
                    </div>
                    <div class="col-md-2" id="vkPostSelect">
                        <label for="postId" class="form-label">ID поста (опционально)</label>
                        <input type="text" class="form-control" id="postId" placeholder="Например: 123">
                        <div class="form-text">Для получения статистики конкретного поста</div>
                    </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary" id="applyFilters">Применить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для статистики -->
    <div id="statsContainer"></div>


</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let vkGroups = [];

    // Загрузка групп при выборе VK
    document.getElementById('platform').addEventListener('change', function() {
    const platform = this.value;
    const vkGroupSelect = document.getElementById('vkGroupSelect');
    
    // Всегда показываем фильтры VK, так как это единственная платформа
    vkGroupSelect.style.display = 'block';
    document.getElementById('vkPostSelect').style.display = 'block';
    loadVKGroups();
});

// Загрузка групп VK (теперь не нужна, так как используется настроенное сообщество)
async function loadVKGroups() {
    // Функция оставлена для совместимости, но больше не используется
    return;
}

// Обновление селекта групп VK (теперь не нужна, так как используется настроенное сообщество)
function updateVKGroupSelect() {
    // Функция оставлена для совместимости, но больше не используется
    return;
}

// Применение фильтров
document.getElementById('applyFilters').addEventListener('click', async function() {
    const platform = document.getElementById('platform').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // Загружаем только VK статистику
    const postId = document.getElementById('postId').value;
    
    if (postId) {
        // Загружаем статистику конкретного поста
        await loadVKPostStats(postId);
    } else {
        // Загружаем общую статистику сообщества
        await loadVKStats(dateFrom, dateTo);
    }
});

// Загрузка статистики конкретного поста VK
async function loadVKPostStats(postId) {
    try {
        console.log('Loading stats for post ID:', postId);
        const response = await fetch(`/smm/vk/stats/${postId}`);
        const result = await response.json();
        
        console.log('Post stats response:', result);
        
        if (result.success) {
            displayVKPostStats(result);
        } else {
            showAlert('Ошибка загрузки статистики поста: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Error loading post stats:', error);
        showAlert('Ошибка загрузки статистики поста', 'danger');
    }
}

// Загрузка статистики VK
async function loadVKStats(dateFrom, dateTo) {
    try {
        const params = new URLSearchParams({
            interval: 'day'
        });
        
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        console.log('Loading VK group stats with params:', params.toString());
        const response = await fetch(`/smm/vk/group-stats?${params.toString()}`);
        const result = await response.json();
        
        console.log('VK group stats response:', result);
        
        if (result.success) {
            displayVKStats(result.stats);
        } else {
            showAlert('Ошибка загрузки статистики: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Error loading VK stats:', error);
        showAlert('Ошибка загрузки статистики', 'danger');
    }
}

// Отображение статистики конкретного поста VK
function displayVKPostStats(result) {
    const statsContainer = document.getElementById('statsContainer');
    
    const html = `
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">Статистика поста #${result.post_id || 'N/A'}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">${result.views || 0}</h4>
                                    <small class="text-muted">Просмотры</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">${result.likes || 0}</h4>
                                    <small class="text-muted">Лайки</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">${result.comments || 0}</h4>
                                    <small class="text-muted">Комментарии</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">${result.reposts || 0}</h4>
                                    <small class="text-muted">Репосты</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    statsContainer.innerHTML = html;
    showAlert('Статистика поста загружена успешно!', 'success');
}

// Отображение статистики VK
function displayVKStats(stats) {
    const statsContainer = document.getElementById('statsContainer');
    
    // Отладочная информация
    console.log('VK Stats received:', stats);
    
    let html = `
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">Статистика сообщества</h6>
                    </div>
                    <div class="card-body">
    `;
    
    if (stats.visitors && stats.visitors.length > 0) {
        const visitors = stats.visitors[0];
        html += `
            <div class="row mb-3">
                <div class="col-md-12">
                    <h6>Посетители</h6>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">${visitors.views || 0}</h4>
                        <small class="text-muted">Просмотры</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${visitors.visitors || 0}</h4>
                        <small class="text-muted">Уникальные посетители</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-secondary">${visitors.mobile_views || 0}</h4>
                        <small class="text-muted">Мобильные просмотры</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (stats.activity && stats.activity.length > 0) {
        const activity = stats.activity[0];
        html += `
            <div class="row">
                <div class="col-md-12">
                    <h6>Активность</h6>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">${activity.likes || 0}</h4>
                        <small class="text-muted">Лайки</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${activity.comments || 0}</h4>
                        <small class="text-muted">Комментарии</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">${activity.reposts || 0}</h4>
                        <small class="text-muted">Репосты</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-dark">${activity.copies || 0}</h4>
                        <small class="text-muted">Копии</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (!stats.visitors && !stats.activity) {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Статистика недоступна или отсутствует за выбранный период
            </div>
        `;
    }
    
    html += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Добавляем детализацию по дням
    if (stats.periods && stats.periods.length > 0) {
        html += `
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="m-0">Статистика по дням</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showOnlyActiveDays">
                                <label class="form-check-label" for="showOnlyActiveDays">
                                    Только активные дни
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Дата</th>
                                            <th class="text-center">Просмотры</th>
                                            <th class="text-center">Посетители</th>
                                            <th class="text-center">Мобильные</th>
                                            <th class="text-center">Лайки</th>
                                            <th class="text-center">Комментарии</th>
                                            <th class="text-center">Репосты</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        // Сортируем периоды по дате (от новых к старым)
        const sortedPeriods = stats.periods.sort((a, b) => b.period_from - a.period_from);
        
        sortedPeriods.forEach(period => {
            const date = new Date(period.period_from * 1000);
            const dateStr = date.toLocaleDateString('ru-RU');
            
            const visitors = period.visitors || {};
            const activity = period.activity || {};
            
            // Подсчитываем общую активность для выделения активных дней
            const totalActivity = (visitors.views || 0) + (activity.likes || 0) + (activity.comments || 0) + (activity.copies || 0);
            const rowClass = totalActivity > 0 ? 'table-success' : '';
            
            html += `
                <tr class="${rowClass}">
                    <td><strong>${dateStr}</strong></td>
                    <td class="text-center">${visitors.views || 0}</td>
                    <td class="text-center">${visitors.visitors || 0}</td>
                    <td class="text-center">${visitors.mobile_views || 0}</td>
                    <td class="text-center">${activity.likes || 0}</td>
                    <td class="text-center">${activity.comments || 0}</td>
                    <td class="text-center">${activity.copies || 0}</td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Дни с активностью выделены зеленым цветом
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    statsContainer.innerHTML = html;
    
    // Добавляем обработчик для переключателя "Только активные дни"
    const showOnlyActiveDaysCheckbox = document.getElementById('showOnlyActiveDays');
    if (showOnlyActiveDaysCheckbox) {
        showOnlyActiveDaysCheckbox.addEventListener('change', function() {
            toggleActiveDaysOnly(this.checked);
        });
    }
    
    showAlert('Статистика загружена успешно!', 'success');
}

// Функция для переключения отображения только активных дней
function toggleActiveDaysOnly(showOnlyActive) {
    const tableRows = document.querySelectorAll('#statsContainer tbody tr');
    
    tableRows.forEach(row => {
        if (showOnlyActive) {
            // Показываем только строки с активностью (зеленые)
            if (row.classList.contains('table-success')) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        } else {
            // Показываем все строки
            row.style.display = '';
        }
    });
}

// Функция показа уведомлений
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Вставляем уведомление в начало контейнера
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
});
</script>
{% endblock %}
